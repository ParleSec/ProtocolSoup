# SPIRE Server Configuration
# Trust Domain: spiffe://protocolsoup.com
# 
# This configuration provides a production-ready SPIRE Server setup for
# demonstrating and implementing SPIFFE workload identity.

server {
    # Bind address for the SPIRE Server API
    bind_address = "0.0.0.0"
    bind_port = "8081"
    
    # Socket path for local admin operations
    socket_path = "/run/spire/sockets/server.sock"
    
    # Trust domain - the root of all SPIFFE IDs issued by this server
    trust_domain = "protocolsoup.com"
    
    # Data directory for server state
    data_dir = "/opt/spire/data/server"
    
    # Logging configuration
    log_level = "INFO"
    log_format = "text"
    
    # CA configuration
    # CA certificate TTL (how long the CA signing certificate is valid)
    ca_ttl = "168h"  # 7 days
    
    # Default SVID TTLs (can be overridden per registration entry)
    default_x509_svid_ttl = "1h"
    default_jwt_svid_ttl = "5m"
    
    # CA key type - EC P-256 provides good security with better performance than RSA
    ca_key_type = "ec-p256"
    
    # JWT issuer - used in JWT-SVID tokens
    jwt_issuer = "https://spiffe.protocolsoup.com"
    
    # Federation configuration
    federation {
        # Bundle endpoint for sharing trust bundles with other trust domains
        bundle_endpoint {
            address = "0.0.0.0"
            port = 8443
        }
    }
    
    # Rate limiting for API calls
    ratelimit {
        attestation = true
        signing = true
    }
}

plugins {
    # DataStore plugin - stores registration entries, bundles, and other server data
    DataStore "sql" {
        plugin_data {
            database_type = "sqlite3"
            connection_string = "/opt/spire/data/server/datastore.sqlite3"
        }
    }
    
    # KeyManager plugin - manages the server's signing keys
    KeyManager "disk" {
        plugin_data {
            keys_path = "/opt/spire/data/server/keys.json"
        }
    }
    
    # NodeAttestor plugins - verify the identity of SPIRE Agents
    
    # Join Token attestor - simple token-based attestation
    # The agent presents a one-time token to prove its identity
    NodeAttestor "join_token" {}
    
    # UpstreamAuthority plugin - for certificate authority chaining
    # Using built-in CA (self-signed root)
    # For production, consider using an external CA like Vault, AWS PCA, etc.
}

# Telemetry configuration
telemetry {
    Prometheus {
        port = 9988
    }
}

# Health checks configuration
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}

