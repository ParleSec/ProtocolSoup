# Protocol Lens - Full Stack with SPIFFE/SPIRE
# Run with: docker compose up -d
# 
# This starts:
# - SPIRE Server (identity authority)
# - SPIRE Agent (embedded in backend for workload attestation)
# - Backend API with real SPIFFE workload identity
# - Frontend UI

services:
  # ============================================
  # SPIRE Server - Identity Authority
  # ============================================
  spire-server:
    build:
      context: ./spire/server
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-server
    hostname: spire-server
    volumes:
      - spire-server-data:/opt/spire/data/server
      - spire-server-socket:/run/spire/sockets
    networks:
      - spire-network
      - showcase-network
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-server", "healthcheck", "-socketPath", "/run/spire/sockets/server.sock"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped

  # ============================================
  # SPIRE Agent - Standalone for other workloads
  # ============================================
  spire-agent:
    build:
      context: ./spire/agent
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-agent
    hostname: spire-agent
    depends_on:
      spire-server:
        condition: service_healthy
    volumes:
      - spire-agent-socket:/run/spire/sockets
      - spire-agent-data:/opt/spire/data/agent
      - spire-server-socket:/run/spire/sockets/server:ro
    networks:
      - spire-network
      - showcase-network
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-agent", "healthcheck", "-socketPath", "/run/spire/sockets/agent.sock"]
      interval: 30s
      timeout: 10s
      start_period: 45s
      retries: 5
    restart: unless-stopped

  # ============================================
  # SPIRE Workload Registration
  # ============================================
  spire-registration:
    build:
      context: ./spire/registration
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-registration
    depends_on:
      spire-server:
        condition: service_healthy
      spire-agent:
        condition: service_healthy
    volumes:
      - spire-server-socket:/run/spire/sockets:ro
    networks:
      - spire-network
    restart: "no"

  # ============================================
  # Backend with embedded SPIRE Agent
  # ============================================
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend-spiffe
    image: docker-backend-spiffe:latest
    container_name: protocol-showcase-backend
    ports:
      - "8080:8080"
    labels:
      - "app=protocol-backend"
      - "spiffe.io/spiffe-id=spiffe://protocolsoup.com/workload/backend"
    volumes:
      - spire-server-socket:/run/spire/sockets/server:ro
      - backend-agent-data:/opt/spire/data/agent
      - scim-data:/app/data
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_MOCK_IDP=true
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
      # SCIM API Token for Okta/Azure AD integration
      # Set this to enable authentication on SCIM endpoints
      # Generate with: openssl rand -hex 32
      - SCIM_API_TOKEN=${SCIM_API_TOKEN:-}
    depends_on:
      spire-server:
        condition: service_healthy
    networks:
      - spire-network
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 5
    restart: unless-stopped

  # ============================================
  # Frontend UI
  # ============================================
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: protocol-showcase-frontend
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - showcase-network
    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  spire-network:
    driver: bridge
  showcase-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  spire-server-data:
    driver: local
  spire-server-socket:
    driver: local
  spire-agent-socket:
    driver: local
  spire-agent-data:
    driver: local
  backend-agent-data:
    driver: local
  scim-data:
    driver: local