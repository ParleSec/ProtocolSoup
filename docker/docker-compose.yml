# Protocol Soup - Split Backend Services (Base)
# Run with: docker compose up -d
#
# This starts:
# - Gateway (API aggregation + protocol routing)
# - Federation service (OAuth2/OIDC/SAML)
# - SCIM service
# - SSF service
# - Frontend UI
#
# ==============================================
# GHCR Public Images
# ==============================================
# To use pre-built images from GitHub Container Registry instead of building locally:
# 1. Comment out the 'build:' section for each service
# 2. Uncomment the 'image:' line with the GHCR URL
#
# Available images:
#   ghcr.io/parlesec/protocolsoup-gateway:latest
#   ghcr.io/parlesec/protocolsoup-federation:latest
#   ghcr.io/parlesec/protocolsoup-scim:latest
#   ghcr.io/parlesec/protocolsoup-ssf:latest
#   ghcr.io/parlesec/protocolsoup-frontend:latest
# ==============================================

services:
  # ============================================
  # Gateway - API Aggregation + Routing
  # ============================================
  gateway:
    # For local development (build from source):
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        SERVICE_CMD: ./cmd/gateway
    # For using published GHCR images, comment 'build:' above and uncomment:
    # image: ghcr.io/parlesec/protocolsoup-gateway:latest
    image: protocol-lens-gateway:latest
    container_name: protocol-lens-gateway
    ports:
      - "8080:8080"
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_LISTEN_ADDR=:8080
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
      - FEDERATION_SERVICE_URL=http://federation-service:8080
      - SCIM_SERVICE_URL=http://scim-service:8080
      - SSF_SERVICE_URL=http://ssf-service:8080
    depends_on:
      federation-service:
        condition: service_started
      scim-service:
        condition: service_started
      ssf-service:
        condition: service_started
    networks:
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 5
    restart: unless-stopped

  # ============================================
  # Federation Service (OAuth2/OIDC/SAML)
  # ============================================
  federation-service:
    # For local development (build from source):
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        SERVICE_CMD: ./cmd/server-federation
    # For using published GHCR images, comment 'build:' above and uncomment:
    # image: ghcr.io/parlesec/protocolsoup-federation:latest
    image: protocol-lens-federation:latest
    container_name: protocol-lens-federation
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_LISTEN_ADDR=:8080
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_MOCK_IDP=true
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
    networks:
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 5
    restart: unless-stopped

  # ============================================
  # SCIM Service
  # ============================================
  scim-service:
    # For local development (build from source):
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        SERVICE_CMD: ./cmd/server-scim
    # For using published GHCR images, comment 'build:' above and uncomment:
    # image: ghcr.io/parlesec/protocolsoup-scim:latest
    image: protocol-lens-scim:latest
    container_name: protocol-lens-scim
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_LISTEN_ADDR=:8080
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
      - SCIM_DATA_DIR=/app/data
      # SCIM API Token for Okta/Azure AD integration
      # Set this to enable authentication on SCIM endpoints
      # Generate with: openssl rand -hex 32
      - SCIM_API_TOKEN=${SCIM_API_TOKEN:-}
    volumes:
      - scim-data:/app/data
    networks:
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 5
    restart: unless-stopped

  # ============================================
  # SSF Service
  # ============================================
  ssf-service:
    # For local development (build from source):
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        SERVICE_CMD: ./cmd/server-ssf
    # For using published GHCR images, comment 'build:' above and uncomment:
    # image: ghcr.io/parlesec/protocolsoup-ssf:latest
    image: protocol-lens-ssf:latest
    container_name: protocol-lens-ssf
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_LISTEN_ADDR=:8080
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
      - SSF_DATA_DIR=/app/data
    volumes:
      - ssf-data:/app/data
    networks:
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 5
    restart: unless-stopped

  # ============================================
  # Frontend UI
  # ============================================
  frontend:
    # For local development (build from source):
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    # For using published GHCR images, comment 'build:' above and uncomment:
    # image: ghcr.io/parlesec/protocolsoup-frontend:latest
    container_name: protocol-showcase-frontend
    ports:
      - "3000:3000"
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - showcase-network
    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  showcase-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  scim-data:
    driver: local
  ssf-data:
    driver: local