# Docker Compose for SPIFFE/SPIRE Infrastructure
# This file sets up the SPIRE Server, Agent, and integrates with the main application.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.spire.yml up
#
# This adds SPIFFE/SPIRE workload identity to the base application stack.

services:
  # ============================================
  # SPIRE Server - Trust Domain Root
  # ============================================
  spire-server:
    build:
      context: ./spire/server
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-server
    hostname: spire-server
    volumes:
      # Persistent storage for server data (CA keys, datastore)
      - spire-server-data:/opt/spire/data/server
      # Server socket for local admin operations
      - spire-server-socket:/run/spire/sockets
    networks:
      - spire-network
      - showcase-network
    ports:
      # Expose federation bundle endpoint for external trust domains
      - "8443:8443"
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-server", "healthcheck", "-socketPath", "/run/spire/sockets/server.sock"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SPIRE Agent - Workload Attestation
  # ============================================
  spire-agent:
    build:
      context: ./spire/agent
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-agent
    hostname: spire-agent
    depends_on:
      spire-server:
        condition: service_healthy
    volumes:
      # Workload API socket - shared with workloads
      - spire-agent-socket:/run/spire/sockets
      # Agent data directory
      - spire-agent-data:/opt/spire/data/agent
      # Server socket - needed for bootstrap token generation
      - spire-server-socket:/run/spire/sockets/server:ro
    networks:
      - spire-network
      - showcase-network
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-agent", "healthcheck", "-socketPath", "/run/spire/sockets/agent.sock"]
      interval: 30s
      timeout: 10s
      start_period: 45s
      retries: 5
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SPIRE Registration - One-time setup container
  # ============================================
  spire-registration:
    build:
      context: ./spire/registration
      dockerfile: Dockerfile
    container_name: protocolsoup-spire-registration
    depends_on:
      spire-server:
        condition: service_healthy
      spire-agent:
        condition: service_healthy
    volumes:
      - spire-server-socket:/run/spire/sockets:ro
    networks:
      - spire-network
    restart: "no"

  # ============================================
  # Backend with embedded SPIFFE Agent (sidecar pattern)
  # This runs the backend and agent in the same container
  # so Unix socket attestation works properly
  # ============================================
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend-spiffe
    image: docker-backend-spiffe:latest
    container_name: protocol-showcase-backend
    ports:
      - "8080:8080"
    labels:
      - "app=protocol-backend"
      - "spiffe.io/spiffe-id=spiffe://protocolsoup.com/workload/backend"
    volumes:
      # Server socket for bootstrap token generation
      - spire-server-socket:/run/spire/sockets/server:ro
      # Persist agent data for faster restarts
      - backend-agent-data:/opt/spire/data/agent
    environment:
      - SHOWCASE_ENV=demo
      - SHOWCASE_BASE_URL=http://localhost:8080
      - SHOWCASE_MOCK_IDP=true
      - SHOWCASE_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
    depends_on:
      spire-server:
        condition: service_healthy
    networks:
      - spire-network
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 5
    restart: unless-stopped

  # ============================================
  # Demo Workloads (disabled - cross-container Unix socket attestation
  # doesn't work in Docker. The backend has embedded SPIRE agent instead)
  # ============================================
  # To enable demo workloads, they would need embedded agents like backend

# ============================================
# Volumes
# ============================================
volumes:
  # SPIRE Server persistent data
  spire-server-data:
    driver: local
  
  # SPIRE Server socket (for admin operations)
  spire-server-socket:
    driver: local
  
  # SPIRE Agent socket (Workload API)
  spire-agent-socket:
    driver: local
  
  # SPIRE Agent persistent data
  spire-agent-data:
    driver: local
  
  # Backend embedded agent data
  backend-agent-data:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  # Dedicated network for SPIRE control plane
  spire-network:
    driver: bridge
    internal: false
  
  # Main application network (shared with base compose)
  showcase-network:
    driver: bridge

